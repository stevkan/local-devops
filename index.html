<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local DevOps</title>
  <link rel="stylesheet" href="./resources/css/main.css">
  <link rel="stylesheet" href="./resources/css/mergeModal.css">
  <link rel="stylesheet" href="./resources/css/settingsModal.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script type='text/javascript' src='./modal/settingsModal.js'></script>
  <script type='text/javascript' src='./resources/scripts/variables.js'></script>
</head>

<body>
  <div class="settingsContainer">
    <button id='openSettingsBtn' type='button'>Settings</button>
  </div>
  <div id='bodyHeaderContainer'>
    <div class="headerContainer">
      <h1 id="headerTitle">Local DevOps</h1>
    </div>
    <div class="headerContainer">
      <button id='loadButton' type='button'>Load/Reload</button>
      <button id='saveButton' type='button' onclick="saveData()">Save Data</button>
      <button id="openImportCsvBtn" type='button'>Import CSV</button>
    </div>
    <div class="headerContainer">
      <button id='toggleDone' type='button' onclick="toggleDone()">Toggle 'Done' Issues</button>
      <button id='resetOrder' type='button'>Reset Order</button>
    </div>
    <div id="mergeModal" class="modal">
      <div class="modal-content">
        <div id='mergeHeaderContainer'>
          <span class='containerHeader'>Merge CSV Files</span>
          <span id="closeMergeModal">&times; Close</span>
        </div>
        <div id="mergeIframeContainer"></div>
      </div>
    </div>
    <div id="settingsModal" class="modal">
      <div class="modal-content">
        <div id='settingsHeaderContainer'>
          <span class='containerHeader'>Settings</span>
          <span id="closeSettingsModal">&times; Close</span>
        </div>
        <div id="settingsIframeContainer"></div>
      </div>
    </div>
  </div>
  <div class="filterContainer">
    <input type="text" id="filter" placeholder="Filter table...">
  </div>
  <table id="data"></table>

  <script>
    let data = [];
    const table = document.getElementById( 'data' );
    let lastOpenedFile = null; // Variable to store the last opened File object
    let selectedRow = null; // Variable to store the selected row for highlighting
    let showDone = true;
    const defaultOrder = [ 1, 1 ];
    localStorage.setItem( 'defaultOrder', defaultOrder );
    let order = [];
    let isComfy = localStorage.getItem( 'comfyMode' ) !== null ? localStorage.getItem( 'comfyMode' ) : false;
    const theme = Variables.theme;
    let themeIndex = [ 'lightTheme.css', 'darkTheme.css', 'customTheme.css' ].indexOf( theme );
    localStorage.setItem( 'themeIndex', themeIndex );
    // localStorage.setItem( 'theme', theme );
    // order.push( localStorage.getItem( 'customOrder' ) !== null ? Number( localStorage.getItem( 'customOrder' ) ) : defaultOrder );
    // localStorage.setItem( 'customOrder', order );

    let clickEvents = [];
    const repositories = [ 'botbuilder-dotnet', 'botbuilder-js', 'botbuilder-python', 'botbuilder-java', 'botbuilder-tools', 'botbuilder-samples', 'botframework-emulator', 'botframework-cli', 'botframework-directlinejs', 'botframework-webchat', 'botframework-composer', 'botframework-components', 'botframework-sdk' ];

    // Get filter input
    const filter = document.getElementById( 'filter' );

    // Add event listener 
    filter.addEventListener( 'keyup', filterRows );

    function filterRows () {
      // Get value to filter by
      const value = filter.value.toLowerCase();

      // Loop through table rows
      const rows = document.querySelectorAll( '#data thead tr.rowSelector' );
      rows.forEach( row => {
        let rowVisible = false;
        const cells = row.querySelectorAll( 'td' );
        cells.forEach( cell => {
          let cellText = '';
          if ( cell.className === 'state' ) {
            cellText = cell.children[ 0 ].value.toLowerCase();
          }
          else cellText = cell.textContent.toLowerCase();

          if ( cellText.includes( value ) ) {
            rowVisible = true;
          }
        } );

        // Show or hide the row based on whether any cell contains the filter value
        row.style.display = rowVisible ? '' : 'none';
      } );
    }

    const reader = new FileReader();
    const openFileBrowser = async () => {
      const input = localStorage.getItem( 'filepath' );
      const fileChooser = document.createElement( 'input' );
      if ( input === '' || input === null ) {
        fileChooser.type = 'file';
        fileChooser.onchange = e => {
          const file = e.target.files[ 0 ];
          const fileName = file.name;
          const filePath = file.path;
          reader.onload = function ( event ) {
            localStorage.setItem( 'filepath', fileName ); // Store the file path in localStorage
          };
          reader.readAsText( file );
        };
        fileChooser.click();
      }
    };

    // Function to open the last opened file
    const openLastFile = () => {
      if ( lastOpenedFile ) {
        reader.onload = function ( event ) {
          const csvData = Papa.parse( event.target.result, { header: true } ).data;
          data = csvData;
          render();
        };
        reader.readAsText( lastOpenedFile );
      } else {
        return false;
      }
    };

    const getData = async () => {
      const myHeaders = new Headers();
      myHeaders.append( "Content-Type", "application/json" );

      const raw = JSON.stringify( {
        "filePath": localStorage.getItem( 'filepath' )
      } );

      const requestOptions = {
        method: "POST",
        mode: "cors",
        credentials: 'include',
        headers: myHeaders,
        body: raw,
        redirect: "follow"
      };

      const response = await fetch( 'http://localhost:6550/file', requestOptions );
      if ( response.ok ) {
        if ( response.status === 204 ) {
          return;
        }
        const json = await response.json();
        return json;
      } else {
        console.log( await response.text() );
        return;
      }
    };

    const saveData = async () => {
      const myHeaders = new Headers();
      myHeaders.append( "Content-Type", "application/json" );

      const raw = JSON.stringify( {
        "filePath": localStorage.getItem( 'filepath' ),
        data
      } );

      const requestOptions = {
        method: "POST",
        headers: myHeaders,
        body: raw,
        redirect: "follow"
      };

      const response = await fetch( 'http://localhost:6550/save', requestOptions );
      if ( response.ok ) {
        const unsavedRows = table.querySelectorAll( '.unsaved' );
        unsavedRows.forEach( row => {
          row.classList.remove( 'unsaved' );
        } );
        alert( 'Data saved successfully!' );
      } else {
        alert( 'Error saving data' );
      }
    };

    const render = () => {
      const onRendered = document.createEvent( 'Event' );
      onRendered.initEvent( 'onRendered', true, true );
      table.innerHTML = '';
      const header = table.createTHead();
      const headers = [ "State", "ID", "Issue ID", "Repository", "Title" ];
      const row = header.insertRow( 0 );
      headers.forEach( headerText => {
        row.classList.add( 'columnSelector' );
        const cell = row.insertCell();
        cell.innerHTML = `<b>${ headerText }</b>`;
        cell.classList.add( 'header' );
        cell.style.cursor = 'pointer';
        cell.dataset.order = 'asc';
        cell.onclick = ( e ) => {
          if ( e.button !== 0 || !e.ctrlKey ) return; // Check for left mouse button click and Control key press
          clickEvents.push( e.target );
          // clickEvents.push( e.target.dataset.order );
          document.addEventListener( 'keydown', ( ( event ) => {
            localStorage.removeItem( 'customOrder' );

            // Define a comparison function for ascending order
            function ascending ( a, b ) {
              if ( b === undefined ) return - 1;
              if ( a < b ) return - 1;
              if ( a > b ) return 1;
              return 0;
            }

            // Get the table rows (excluding the header row)
            var tableRows = document.querySelectorAll( '#data tr:not(:first-child)' );

            switch ( e.target.innerHTML ) {
              case "State":
              case "<b>State</b>":
                order.splice( 0, 0, 0 );
                break;
              case "ID":
              case "<b>ID</b>":
                order.splice( 0, 0, 1 );
                break;
              case "Issue ID":
              case "<b>Issue ID</b>":
                order.splice( 0, 0, 2 );
                break;
              case "Repository":
              case "<b>Repository</b>":
                order.splice( 0, 0, 3 );
                break;
              case "Title":
              case "<b>Title</b>":
                order.splice( 0, 0, 4 );
                break;
              default:
                break;
            }
            if ( order.length > 2 ) {
              order.splice( 2 );
            }
            localStorage.setItem( 'customOrder', order );
            // Sort the rows
            tableRows = Array.from( tableRows ).sort( function ( rowA, rowB ) {
              if ( clickEvents.length === 1 ) {
                // var keyA1 = rowA.dataset.order === 'asc' ? 'desc' : 'asc';

                const wordsA = rowA.children[ 0 ].children[ 0 ].id.split( ' ' );
                const joinedWordsA = wordsA.join( '-' );
                var keyA1 = joinedWordsA.toLowerCase();
                // var keyB1 = rowA.children[ 0 ].children[ 0 ].id.replace( ' ', '-' ).toLowerCase();
                // if ( keyA1 === keyB1 ) {
                var result = ascending( keyA1 );
                return result;
                // }
              }
              if ( order.length === 1 ) {
                if ( rowA.children[ order[ 0 ] ].className === 'state' ) {
                  var keyA1 = rowA.children[ order[ 0 ] ].children[ 0 ].id.replace( ' ', '-' ).toLowerCase();
                  var keyB1 = rowB.children[ order[ 0 ] ].children[ 0 ].id.replace( ' ', '-' ).toLowerCase();
                } else {
                  var keyA1 = rowA.children[ order[ 0 ] ].textContent.toUpperCase();
                  var keyB1 = rowB.children[ order[ 0 ] ].textContent.toUpperCase();
                }
                var result = ascending( keyA1, keyB1 );
              }
              if ( order.length === 2 ) {

                var keyA1 = rowA.children[ order[ 1 ] ].textContent.toUpperCase();
                var keyB1 = rowB.children[ order[ 1 ] ].textContent.toUpperCase();

                if ( rowA.children[ order[ 0 ] ].className === 'state' ) {
                  var keyA2 = rowA.children[ order[ 0 ] ].children[ 0 ].id.replace( ' ', '-' ).toLowerCase();
                  var keyB2 = rowB.children[ order[ 0 ] ].children[ 0 ].id.replace( ' ', '-' ).toLowerCase();
                } else {
                  var keyA2 = rowA.children[ order[ 0 ] ].textContent.toUpperCase();
                  var keyB2 = rowB.children[ order[ 0 ] ].textContent.toUpperCase();
                }
                var result = ascending( keyA2, keyB2 );
              }

              // If Column C values are equal, compare by Column E
              if ( result === 0 ) {
                // result = ascending( keyA2, keyB2 );
              }
              return result;
            } );

            // Clear the existing table rows
            var tableBody = document.querySelector( '#data thead' );

            // Append the sorted rows back to the table
            tableRows.forEach( function ( row ) {
              tableBody.appendChild( row );
            } );
          } )() );
          const clickTimeout = setTimeout( () => {
            order = [];
            clickEvents = [];
          }, 1500 );
        };
        table.dispatchEvent( onRendered );
      } );
      data.forEach( ( row, i ) => {
        if ( row.ID === undefined || row.ID === null || row.ID === '' ) return;
        const rowElement = table.insertRow();
        rowElement.classList.add( 'rowSelector' );
        headers.forEach( headerText => {
          const cell = rowElement.insertCell();
          cell.classList.add( `${ headerText.replace( ' ', '-' ).toLowerCase() }` );
          localStorage.getItem( 'comfyMode' ) === 'true' ? cell.classList.add( 'comfy-mode' ) : cell.classList.remove( 'comfy-mode' );
          if ( headerText !== "State" && headerText !== "Title" ) {
            if ( row[ headerText ] === "(Unknown)" && row[ 'Issue URL' ].includes( 'portal.microsofticm.com' ) ) {
              row[ headerText ] = "IcM";
            }
            if ( row[ headerText ] === "(Unknown)" && row[ 'Issue URL' ].includes( 'stackoverflow.com' ) ) {
              row[ headerText ] = "StackOverflow";
            }
            if ( repositories.includes( row[ headerText ].toLowerCase() ) ) {
              const words = row[ headerText ].split( '-' );
              const capitalizedWords = words.map( word => word.charAt( 0 ).toUpperCase() + word.slice( 1 ) );
              row[ headerText ] = capitalizedWords.join( '-' );
            }
            cell.innerHTML = row[ headerText ];
          }
          if ( headerText === "Title" ) {
            const urlElement = row[ 'Issue URL' ];
            const tempContainer = document.createElement( 'div' );
            tempContainer.innerHTML = urlElement;
            const url = tempContainer.getElementsByTagName( 'a' )[ 0 ].href;
            cell.innerHTML = `<a href="${ url }" target="_blank">${ row[ headerText ] }</a>`;
          }
          if ( headerText === "State" ) {
            const select = document.createElement( 'select' );
            select.id = row.State + '-' + row.ID;
            select.innerHTML = `
              <option ${ row.State === 'To Do' ? 'selected' : '' } class='to-do' value='To Do'>To Do</option>
              <option ${ row.State === 'Investigating' ? 'selected' : '' } class='investigating' value='Investigating'>Investigating</option>
              <option ${ row.State === 'Waiting on Customer' ? 'selected' : '' } class='waiting-on-customer' value='Waiting on Customer'>Waiting on Customer</option>
              <option ${ row.State === 'Waiting on Internal Task' ? 'selected' : '' } class='waiting-on-internal-task' value='Waiting on Internal Task'>Waiting on Internal Task</option>  
              <option ${ row.State === 'Done' ? 'selected' : '' } class='done' value='Done'>Done</option>
            `;
            select.value = row[ headerText ];
            select.onchange = () => {
              row[ headerText ] = select.value;
              select.parentNode.parentNode.classList.add( 'unsaved' );
              table.dispatchEvent( onRendered );
            };
            cell.appendChild( select );
          }
        } );
      } );

      table.addEventListener( 'onRendered', ( e ) => {
        document.querySelectorAll( 'select option' ).forEach( option => {

          if ( option.selected ) {
            switch ( option.value ) {
              case 'To Do':
                option.parentNode.style.backgroundColor = 'darkred';
                option.parentNode.style.color = 'white';
                break;
              case 'Investigating':
                option.parentNode.style.backgroundColor = 'orange';
                option.parentNode.style.color = 'black';
                break;
              case 'Waiting on Internal Task':
                option.parentNode.style.backgroundColor = 'yellow';
                option.parentNode.style.color = 'black';
                break;
              case 'Waiting on Customer':
                option.parentNode.style.backgroundColor = 'blue';
                option.parentNode.style.color = 'white';
                break;
              case 'Done':
                option.parentNode.style.backgroundColor = 'green';
                option.parentNode.style.color = 'white';
                break;
              default:
                option.parentNode.style.backgroundColor = '#181818';
                option.parentNode.style.color = 'white';
                break;
            }
          }
        } );
      } );


      table.dispatchEvent( onRendered );
      document.addEventListener( 'click', ( event ) => {
        if ( event.target.localName === 'td' ) {
          const target = event.target.closest( 'tr' );
          const children = table.tHead.children;
          for ( child of children ) {
            if ( child === target ) {
              if ( selectedRow ) {
                selectedRow.classList.remove( 'selected' );
              }
              selectedRow = target;
              selectedRow.classList.add( 'selected' );
            }
          };
        }
        else {
          if ( selectedRow ) {
            selectedRow.classList.remove( 'selected' );
            selectedRow = null;
          }
        }
      } );
    };

    const toggleDone = () => {
      showDone = !showDone;
      const doneRows = table.querySelectorAll( 'select option' ).forEach( option => {
        if ( option.selected ) {
          switch ( option.value ) {
            case 'Done':
              const row = option.parentNode.parentNode.parentNode;
              row.style.display = showDone ? 'none' : 'table-row';
              break;
            default:
              break;
          }
        }
      } );
    };

    const resetOrderButton = document.getElementById( 'resetOrder' );

    resetOrderButton.addEventListener( 'click', () => {
      order = defaultOrder;
      localStorage.setItem( 'customOrder', defaultOrder );
      render();
    } );

    const loadButton = document.getElementById( 'loadButton' );
    loadButton.addEventListener( 'click', async () => {
      order = [];
      order.push( Number( localStorage.getItem( 'customOrder' ) ) );
      await openFileBrowser()
        .then( ( res ) => {
          const interval = setInterval( async () => {
            const input = localStorage.getItem( 'filepath' );
            if ( input !== null ) {
              const fileData = await getData();
              lastOpenedFile = fileData ? new File( [ fileData ], 'DevOpsIssues.csv', { type: 'text/csv' } ) : null;
              openLastFile();
              clearInterval( interval );
            }
          }, 100 );
        } );
    } );

    const mergeModal = document.getElementById( 'mergeModal' );
    const openImportCsvBtn = document.getElementById( 'openImportCsvBtn' );
    const closeMergeModal = document.getElementById( 'closeMergeModal' );
    const mergeIframeContainer = document.getElementById( 'mergeIframeContainer' );

    openImportCsvBtn.addEventListener( 'click', () => {
      mergeModal.style.display = 'flex';
      const iframe = document.createElement( 'iframe' );
      iframe.id = 'mergeModalIframe';
      iframe.src = 'mergeModal.html'; // Replace with the desired URL
      iframe.style.width = '100%';
      iframe.style.height = '100%'; // Adjust the height as needed
      mergeIframeContainer.appendChild( iframe );
    } );

    closeMergeModal.addEventListener( 'click', () => {
      const iframe = document.getElementById( 'mergeModalIframe' );
      mergeModal.style.display = 'none';
      mergeIframeContainer.removeChild( iframe );
    } );

    const settingsModal = document.getElementById( 'settingsModal' );
    const openSettingsBtn = document.getElementById( 'openSettingsBtn' );
    const closeSettingsModal = document.getElementById( 'closeSettingsModal' );
    const settingsIframeContainer = document.getElementById( 'settingsIframeContainer' );

    openSettingsBtn.addEventListener( 'click', () => {
      settingsModal.style.display = 'flex';
      const iframe = document.createElement( 'iframe' );
      iframe.id = 'settingsModalIframe';
      iframe.src = 'settingsModal.html'; // Replace with the desired URL
      iframe.style.width = '100%';
      iframe.style.height = '100%'; // Adjust the height as needed
      settingsIframeContainer.appendChild( iframe );
    } );

    closeSettingsModal.addEventListener( 'click', () => {
      const iframe = document.getElementById( 'settingsModalIframe' );
      settingsModal.style.display = 'none';
      settingsIframeContainer.removeChild( iframe );
    } );

    function toggleComfySetting () {
      isComfy = !isComfy;
      const comfyMode = localStorage.setItem( 'comfyMode', isComfy );

      const cells = document.querySelectorAll( '#data td' );
      if ( isComfy ) {
        cells.forEach( cell => {
          cell.classList.add( 'comfy-mode' );
        } );
      } else {
        cells.forEach( cell => {
          cell.classList.remove( 'comfy-mode' );
        } );
      }
    }

    const themes = [ 'lightTheme.css', 'darkTheme.css', 'customTheme.css' ];
    function toggleThemeSetting () {
      themeIndex++;
      const nextTheme = themes[ themeIndex - 1 ];
      const currentThemeIndex = themes.findIndex( theme => theme === nextTheme );
      themes.keys();
      localStorage.setItem( 'theme', nextTheme );
      localStorage.setItem( 'themeIndex', currentThemeIndex );
      const link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = `./resources/css/${ nextTheme }`; // Path to your CSS file

      document.head.appendChild( link );
      if ( themeIndex > 2 ) {
        themeIndex = 0;
      }
    }

    table.onload = toggleDone();
    window.onload = async () => {
      toggleComfySetting();
      SettingsModal.onload();
      loadButton.click();
    };
  </script>
</body>

</html>